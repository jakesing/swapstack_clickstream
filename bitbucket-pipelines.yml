image: node:gallium-alpine3.16

options:
  max-time: 15

pipelines:
  branches:
    develop:
      - step:
          name: Deploy API
          deployment: stage
          caches:
            - node
          script:
            - cd api
            - npm ci
            - npx serverless deploy --stage $ENVIRONMENT --region $AWS_REGION

      - step:
          name: Deploy API
          deployment: live
          trigger: manual
          caches:
            - node
          script:
            - cd api
            - npm ci
            - npx serverless deploy --stage $ENVIRONMENT --region $AWS_REGION
  custom:
    remove-stage-api:
      - step:
          name: Remove Stage API
          deployment: stage
          caches:
            - node
          script:
            - cd api
            - npm ci
            - npx serverless remove --stage $ENVIRONMENT --region $AWS_REGION

    remove-live-api:
      - step:
          name: Remove Stage API
          deployment: live
          caches:
            - node
          script:
            - cd api
            - npm ci
            - npx serverless remove --stage $ENVIRONMENT --region $AWS_REGION
